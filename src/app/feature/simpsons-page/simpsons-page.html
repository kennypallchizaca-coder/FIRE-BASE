<section class="p-8">

  <app-breadcrumbs [items]="[
    { label: 'Inicio', link: '/' },
    { label: 'Simpsons', link: '/simpsons' },
    { label: 'Personajes' }
  ]" />

  <app-hero-simpsons 
    [simpsonsCount]="simpsonsResource.value()?.count ?? 0" 
    [totalPages]="totalPages()">
  </app-hero-simpsons>

  @if (simpsonsResource.isLoading()) {
    <div class="flex justify-center items-center h-64">
      <span class="loading loading-spinner loading-lg text-primary"></span>
    </div>
  }

  @if (simpsonsResource.error()) {
    <div class="alert alert-error my-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
      <span>Error cargando personajes. Revisa la consola (F12).</span>
    </div>
  }

  @if (simpsonsResource.hasValue()) {
    <div class="flex gap-2 items-center h-20 mb-4">
      <select class="select select-bordered w-32" (change)="charactersPerPage.set(+selectPerPage.value)" #selectPerPage>
        <option value="10">10</option>
        <option value="20">20</option>
        <option value="50">50</option>
        <option value="100">100</option>
      </select>

      <app-pagination-component 
        [pages]="totalPages()" 
        [currentPage]="paginationService.currentPage()" 
      />
      <div class="flex flex-1"></div>
    </div>
  }

  @if (simpsonsResource.hasValue()) {
    <div class="overflow-x-auto mb-12"> 
      <table class="table table-zebra">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nombre</th>
            <th>Ocupaci√≥n</th>
            <th>Estado</th>
            <th>Detalles</th> 
            <th>Favorito</th> 
          </tr>
        </thead>

        <tbody>
          @for (personaje of simpsonsResource.value().results; track personaje.id) {
            <tr>
              <td>{{ personaje.id }}</td>
              <td class="font-bold">{{ personaje.name }}</td>
              <td>{{ personaje.occupation }}</td>
              <td>
                <span class="badge badge-{{ personaje.status === 'Alive' ? 'success' : 'error' }}">
                  {{ personaje.status }}
                </span>
              </td>
              
              <td>
                <a [routerLink]="['/simpsons', personaje.id]" class="btn btn-sm btn-primary">
                  Ver Detalle
                </a>
              </td>

              <td>
                @if (isFavorite(personaje.name)) {
                  <button class="btn btn-sm btn-ghost text-warning" disabled>
                    ‚≠ê Guardado
                  </button>
                } @else {
                  <button class="btn btn-sm btn-outline btn-warning" (click)="addToFavorites(personaje)">
                    ‚òÜ Agregar
                  </button>
                }
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  <div class="divider"></div> 

  <div class="mt-8">
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-2xl font-bold">‚≠ê Mis Favoritos</h2>
      
      <button class="btn btn-sm btn-ghost" (click)="reloadFavorites()" [disabled]="loadingFavorites()">
        @if (loadingFavorites()) {
          <span class="loading loading-spinner loading-sm"></span>
        } @else {
          üîÑ Actualizar
        }
      </button>
    </div>

    @if (loadingFavorites()) {
      <div class="flex justify-center items-center py-12">
        <span class="loading loading-spinner loading-lg"></span>
      </div>
    } 
    @else if (favorites().length === 0) {
      <div class="alert alert-info">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
        </svg>
        <span>No tienes favoritos a√∫n. ¬°Agrega algunos personajes de la tabla de arriba!</span>
      </div>
    } 
    @else {
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        @for (favorite of favorites(); track favorite.id) {
          <div class="card bg-base-100 shadow-xl border border-base-200">
            <figure class="px-4 pt-4">
              <img
                [src]="buildImageUrl(favorite.image)"
                [alt]="favorite.nombre"
                class="rounded-xl h-48 w-full object-contain bg-base-200"
              />
            </figure>
            
            <div class="card-body">
              <h3 class="card-title text-sm">{{ favorite.nombre }}</h3>

              @if (editingFavoriteId() === favorite.id) {
                <form [formGroup]="editForm" class="form-control">
                  <input 
                    type="text" 
                    formControlName="customName" 
                    class="input input-bordered input-sm mb-2"
                    [class.input-error]="editForm.get('customName')?.invalid && editForm.get('customName')?.touched"
                    placeholder="Nombre personalizado" 
                    (keyup.enter)="saveEditedFavorite()"
                    (keyup.escape)="cancelEditingFavorite()" 
                  />
                  
                  <div class="flex gap-2">
                    <button type="button" class="btn btn-xs btn-success flex-1" (click)="saveEditedFavorite()" [disabled]="editForm.invalid">
                      ‚úì Guardar
                    </button>
                    <button type="button" class="btn btn-xs btn-ghost flex-1" (click)="cancelEditingFavorite()">
                      ‚úï Cancelar
                    </button>
                  </div>
                </form>
              } 
              @else {
                <p class="text-xs opacity-70">
                  <span class="font-semibold">Alias:</span><br />
                  {{ favorite.customName }}
                </p>

                <div class="card-actions justify-end mt-2">
                  <button class="btn btn-xs btn-ghost" (click)="startEditingFavorite(favorite)">
                    ‚úèÔ∏è Editar
                  </button>
                  <button class="btn btn-xs btn-error btn-outline" (click)="removeFromFavorites(favorite.id!)">
                    üóëÔ∏è Eliminar
                  </button>
                </div>
              }
            </div>
          </div>
        }
      </div>
    }
  </div>

</section>